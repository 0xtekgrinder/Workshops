# Workshop 17 - gRPC and Protocol Buffers with TypeScript

:heavy_check_mark: Write protobuf files

:heavy_check_mark: Write your gRPC service

:heavy_check_mark: Write your gRPC messages

:heavy_check_mark: Implement a TypeScript gRPC client

:heavy_check_mark: Implement a TypeScript gRPC server

:heavy_check_mark: Test your implementations

## :gear: Step 0 - Setup

All the required information to install dependencies can be found in [SETUP.md](./SETUP.md).

## :pencil2: Step 1 - Writing protobuf file

gRPC stands for **g**oogle **R**emote **P**rocedure **C**all.
It is a framework developed by Google on top of the [RPC protocol](https://en.wikipedia.org/wiki/Remote_procedure_call).
If you want to learn more about the differences between gRPC and REST, you can read [this great blogpost](https://www.imaginarycloud.com/blog/grpc-vs-rest/#comparison).
When dealing with gRPC, the data sent between the client and the server is packed in a specific format : protobuffers.

> :bulb: Okay, but why do we use protobuf and not JSON ? [JSON are nice](https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Objects/JSON#json_structure) : they are human-readable, easy to build and to extract.
In fact, it is the data serialization method used in a lot of REST APIs.

- The main issue with JSON is the following : it is really heavy, because the data sent is formatted into a string.

- Meanwhile, protobuf serialize data in a binary format, which makes the communication really fast !

- So we need to define the data we will send into a .proto file. Let's do it !

### Unary gRPC call

> :bulb: Starting with the unary call. You can think as this as the standard Request/Response model.

In this step, you must create:

- A `pochat.proto` file in the `proto` folder. The package name in the protobuf file must be `PoChat`.

- A gRPC service named `Chat`
  
- With one rpc call, named `Hello`.

  - The `Hello` call will take a `HelloRequest` message as the argument containing a string named `name`.
  - And will return a `HelloResponse` message as the response containing a string named `greetings`.


## :repeat: Step 2 - Generating TypeScript definitions

So now that your protobuf file is ready, you can generate the TypeScript definition using the following command:
```shell
yarn protogen
```

Some files should have appeared in the `proto` folder.

## :floppy_disk: Step 3 - The server

> :bulb: Let's get to the fun part : implementing the server.

What's nice about gRPC is that is does a lot of the work for you. Because you and I are lazy, that's the dream.

So here is what you'll have to do:

- In the `src/server.ts` file, you'll find some code. **Don't modify this code**, it is responsible for importing the gRPC package that you'll have to use.

- Create a `PoChatServer` class and export it as the default export.
  
- It's constructor must initialize it's `server` member using the `@grpc/grpc-js` package.

- After the initialization, it must add the pochat.Chat service. For the moment, just print the request data.

- Then, you must bind the address `localhost:3000` to the server.

- Finally, use the start method to start the server, still in the constructor.

> :bulb: The implementation of the service must be cast to a `ChatHandlers` object.

> :bulb: Use `bindAsync` to add a `console.log` in the callback.

Here is some documentation for you about TypeScript:

- [TypeScript class](https://www.typescriptlang.org/docs/handbook/classes.html)

- [TypeScript cast](https://www.typescripttutorial.net/typescript-tutorial/type-casting/)


## :computer: Step 4 - The client

> :bulb: Let's now implement the client !

- In the `src/client.ts` file, same as before, do not modify the code already there.

- Create a `PoChatClient` class and export it as the default export.

- It's constructor must initialize it's `client` member using the `pochat` variable holding the `ChatClient` interface generated by the protobuf. Tips: use an insecure connection from the `credentials` module.of the `@grpc/grpc-js` package.

- Then, create a method named `hello`. It will wrap the `this.client.hello(...)` method. Look closely at the parameters required here !

Here is some documentation for you about gRPC in Node:

- [gRPC and Node](https://grpc.io/docs/languages/node/)


## :microscope: Step 5 - Adding some tests

> :bulb: Well writing code is nice, but without adding some tests ? Hell no.

In the `tests/chat.test.ts`, you'll write tests to ensure that the communication between the client and the server works properly.

Remember to start the server with the following command whenever you run the client tests:
```shell
yarn start:server
```

Add the following tests to the suite using [jest](https://jestjs.io/):

- It can create the client

- It can send the hello message

- The server can respond `hello from server` to any incoming `hello` gRPC call.

> :bulb: You'll have to modify the implementation of the service in the server and use the second argument.

You can learn more about jest tests [here](https://jestjs.io/docs/api).

## :rocket: To go further

If you want to learn more about gRPC project out there, check out [this](https://github.com/grpc-ecosystem/awesome-grpc) list of amazing project that uses it.

You can add more services to the protobuf file, passing other type of parameters instead of a string, or even combining several data types.

## :wave: Authors

- [PtitLuca](https://github.com/PtitLuca)

Made with :heart: by PoC.

If you want to support our work, please add a :star: to this repository !
